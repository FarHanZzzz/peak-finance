{% extends "base.html" %}

{% block title %}Dashboard - Peak Finance{% endblock %}

{% block content %}
<section class="dashboard-shell">
    <div class="container">
        <header class="dashboard-header">
            <div class="dashboard-headline">
                <span class="eyebrow">Personal finance cockpit</span>
                <h1>Welcome back ðŸ‘‹</h1>
                <p id="userWelcome">Loadingâ€¦</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="showProfileModal()">
                    <i class="fas fa-user-circle"></i>
                    Profile & preferences
                </button>
            </div>
        </header>

        <section class="kpi-grid" id="statsGrid">
            <article class="kpi-card skeleton">
                <div class="kpi-icon"><i class="fas fa-spinner fa-spin"></i></div>
                <div>
                    <p class="kpi-label">Loadingâ€¦</p>
                    <h3 class="kpi-value">---</h3>
                </div>
            </article>
        </section>

        <div class="dashboard-layout">
            <div class="panel-column">
                <article class="panel">
                    <header class="panel-header">
                        <div>
                            <h2><i class="fas fa-receipt"></i> Expenses timeline</h2>
                            <p>Track fixed and variable outflows to understand where your taka travels.</p>
                        </div>
                        <button class="btn btn-small btn-primary" onclick="showAddExpenseModal()">
                            <i class="fas fa-plus"></i> Add expense
                        </button>
                    </header>
                    <div id="expensesList" class="panel-body items-list">
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i> Loading expensesâ€¦
                        </div>
                    </div>
                </article>

                <article class="panel">
                    <header class="panel-header">
                        <div>
                            <h2><i class="fas fa-credit-card"></i> Debt & loans</h2>
                            <p>Monitor EMI impact and remaining principals across all liabilities.</p>
                        </div>
                        <button class="btn btn-small btn-primary" onclick="showAddDebtModal()">
                            <i class="fas fa-plus"></i> Add debt
                        </button>
                    </header>
                    <div id="debtsList" class="panel-body items-list">
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i> Loading debtsâ€¦
                        </div>
                    </div>
                </article>
            </div>

            <div class="panel-column">
                <article class="panel">
                    <header class="panel-header">
                        <div>
                            <h2><i class="fas fa-bullseye"></i> Financial goals</h2>
                            <p>Visualize progress bars, priorities, and time-to-target in one place.</p>
                        </div>
                        <button class="btn btn-small btn-primary" onclick="showAddGoalModal()">
                            <i class="fas fa-plus"></i> Add goal
                        </button>
                    </header>
                    <div id="goalsList" class="panel-body items-list">
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i> Loading goalsâ€¦
                        </div>
                    </div>
                </article>

                <article class="panel quick-tools">
                    <header class="panel-header">
                        <div>
                            <h2><i class="fas fa-wand-magic"></i> Quick tools</h2>
                            <p>Launch calculators and automations without leaving your dashboard.</p>
                        </div>
                    </header>
                    <div class="tool-grid">
                        <button class="tool-button" onclick="showLoanCalculator()">
                            <i class="fas fa-hand-holding-dollar"></i>
                            <span>Loan affordability</span>
                        </button>
                        <button class="tool-button" onclick="showInflationCalculator()">
                            <i class="fas fa-chart-line"></i>
                            <span>Inflation forecast</span>
                        </button>
                        <button class="tool-button" onclick="showAIAdvisor()">
                            <i class="fas fa-robot"></i>
                            <span>AI advisor</span>
                        </button>
                        <button class="tool-button" onclick="showDataImport()">
                            <i class="fas fa-file-import"></i>
                            <span>Import CSV</span>
                        </button>
                    </div>
                    <div class="tool-note">
                        <i class="fas fa-shield-check"></i>
                        <p>All actions remain educational. Sensitive prompts are logged and gated per BFIU guidelines.</p>
                    </div>
                </article>
            </div>
        </div>
    </div>
</section>

<div id="modalContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
// Dashboard state
let dashboardData = {
    user: null,
    expenses: [],
    debts: [],
    goals: [],
    summary: null
};

// Check auth and initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (!Auth.isAuthenticated()) {
        window.location.href = '/auth';
        return;
    }
    initDashboard();
});

// Initialize dashboard
async function initDashboard() {
    try {
        await loadUserProfile();
        await Promise.all([
            loadDashboardSummary(),
            loadExpenses(),
            loadDebts(),
            loadGoals()
        ]);
    } catch (error) {
        console.error('Dashboard initialization error:', error);
        showToast(error.message || 'Failed to load dashboard', 'error');
    }
}

// Load user profile
async function loadUserProfile() {
    try {
        dashboardData.user = await API.get('/auth/me');
        document.getElementById('userWelcome').textContent = 
            `${dashboardData.user.email} | Income: à§³${formatNumber(dashboardData.user.monthly_net_income)}`;
    } catch (error) {
        throw new Error('Failed to load user profile');
    }
}

// Load dashboard summary
async function loadDashboardSummary() {
    try {
        dashboardData.summary = await API.get('/calc/dashboard');
        renderSummaryCards();
    } catch (error) {
        console.error('Summary load error:', error);
        // Show default summary for new users
        renderDefaultSummary();
    }
}

// Render default summary for new users
function renderDefaultSummary() {
    const statsGrid = document.getElementById('statsGrid');
    const income = dashboardData.user?.monthly_net_income || 0;
    
    statsGrid.innerHTML = `
        <div class="stat-card primary">
            <div class="stat-icon"><i class="fas fa-wallet"></i></div>
            <div class="stat-info">
                <p class="stat-label">Monthly Income</p>
                <h3 class="stat-value">à§³${formatNumber(income)}</h3>
                ${income === 0 ? '<p class="stat-note"><small>Set your income in profile</small></p>' : ''}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
            <div class="stat-info">
                <p class="stat-label">Getting Started</p>
                <h3 class="stat-value">Welcome!</h3>
                <p class="stat-note"><small>Add expenses and goals below</small></p>
            </div>
        </div>
        <div class="stat-card success">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info">
                <p class="stat-label">Status</p>
                <h3 class="stat-value">Ready</h3>
                <p class="stat-note"><small>Start tracking your finances</small></p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-lightbulb"></i></div>
            <div class="stat-info">
                <p class="stat-label">Quick Tip</p>
                <h3 class="stat-value">Track!</h3>
                <p class="stat-note"><small>Add your first expense</small></p>
            </div>
        </div>
    `;
}

// Load expenses
async function loadExpenses() {
    try {
        dashboardData.expenses = await API.get('/profile/expenses');
        renderExpenses();
    } catch (error) {
        document.getElementById('expensesList').innerHTML = 
            '<p class="empty-state">No expenses yet. <a href="#" onclick="showAddExpenseModal()">Add your first expense</a></p>';
    }
}

// Load debts
async function loadDebts() {
    try {
        dashboardData.debts = await API.get('/profile/debts');
        renderDebts();
    } catch (error) {
        document.getElementById('debtsList').innerHTML = 
            '<p class="empty-state">No debts tracked. <a href="#" onclick="showAddDebtModal()">Add a loan</a></p>';
    }
}

// Load goals
async function loadGoals() {
    try {
        dashboardData.goals = await API.get('/profile/goals');
        renderGoals();
    } catch (error) {
        document.getElementById('goalsList').innerHTML = 
            '<p class="empty-state">No goals set. <a href="#" onclick="showAddGoalModal()">Set your first goal</a></p>';
    }
}

// Render summary cards
function renderSummaryCards() {
    const s = dashboardData.summary;
    if (!s) return;

    const statsGrid = document.getElementById('statsGrid');
    statsGrid.innerHTML = `
        <div class="stat-card primary">
            <div class="stat-icon"><i class="fas fa-wallet"></i></div>
            <div class="stat-info">
                <p class="stat-label">Monthly Income</p>
                <h3 class="stat-value">à§³${formatNumber(s.total_income)}</h3>
            </div>
        </div>
        <div class="stat-card ${s.surplus >= 0 ? 'success' : 'danger'}">
            <div class="stat-icon"><i class="fas fa-${s.surplus >= 0 ? 'arrow-up' : 'arrow-down'}"></i></div>
            <div class="stat-info">
                <p class="stat-label">Monthly Surplus</p>
                <h3 class="stat-value">à§³${formatNumber(s.surplus)}</h3>
            </div>
        </div>
        <div class="stat-card ${s.dti < 0.35 ? 'success' : s.dti < 0.45 ? 'warning' : 'danger'}">
            <div class="stat-icon"><i class="fas fa-percentage"></i></div>
            <div class="stat-info">
                <p class="stat-label">Debt-to-Income</p>
                <h3 class="stat-value">${(s.dti * 100).toFixed(1)}%</h3>
            </div>
        </div>
        <div class="stat-card success">
            <div class="stat-icon"><i class="fas fa-hand-holding-usd"></i></div>
            <div class="stat-info">
                <p class="stat-label">Safe to Spend</p>
                <h3 class="stat-value">à§³${formatNumber(s.safe_to_spend)}</h3>
            </div>
        </div>
    `;
}

// Render expenses
function renderExpenses() {
    const list = document.getElementById('expensesList');
    if (!dashboardData.expenses || dashboardData.expenses.length === 0) {
        list.innerHTML = '<p class="empty-state">No expenses yet. <a href="#" onclick="showAddExpenseModal()">Add your first expense</a></p>';
        return;
    }

    const totalFixed = dashboardData.expenses.filter(e => e.type === 'fixed').reduce((sum, e) => sum + e.amount, 0);
    const totalVariable = dashboardData.expenses.filter(e => e.type === 'variable').reduce((sum, e) => sum + e.amount, 0);

    list.innerHTML = `
        <div class="list-summary">
            <div class="summary-item">
                <span>Fixed: à§³${formatNumber(totalFixed)}</span>
                <span>Variable: à§³${formatNumber(totalVariable)}</span>
            </div>
            <div class="summary-total">Total: à§³${formatNumber(totalFixed + totalVariable)}</div>
        </div>
        ${dashboardData.expenses.map(expense => `
            <div class="list-item">
                <div class="item-icon ${expense.type}">
                    <i class="fas fa-${expense.type === 'fixed' ? 'home' : 'shopping-cart'}"></i>
                </div>
                <div class="item-content">
                    <div class="item-name">${escapeHtml(expense.name)}</div>
                    <div class="item-meta">${expense.type}</div>
                </div>
                <div class="item-amount">à§³${formatNumber(expense.amount)}</div>
                <button class="item-delete" onclick="deleteExpense(${expense.id})" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('')}
    `;
}

// Render debts
function renderDebts() {
    const list = document.getElementById('debtsList');
    if (!dashboardData.debts || dashboardData.debts.length === 0) {
        list.innerHTML = '<p class="empty-state">No debts tracked. <a href="#" onclick="showAddDebtModal()">Add a loan</a></p>';
        return;
    }

    const totalEMI = dashboardData.debts.reduce((sum, d) => sum + d.current_emi, 0);

    list.innerHTML = `
        <div class="list-summary">
            <div class="summary-total">Total EMI: à§³${formatNumber(totalEMI)}/month</div>
        </div>
        ${dashboardData.debts.map(debt => `
            <div class="list-item">
                <div class="item-icon debt">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="item-content">
                    <div class="item-name">${escapeHtml(debt.name)}</div>
                    <div class="item-meta">à§³${formatNumber(debt.principal)} @ ${debt.annual_rate_pct}% | ${debt.term_months}mo</div>
                </div>
                <div class="item-amount">à§³${formatNumber(debt.current_emi)}/mo</div>
                <button class="item-delete" onclick="deleteDebt(${debt.id})" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('')}
    `;
}

// Render goals
function renderGoals() {
    const list = document.getElementById('goalsList');
    if (!dashboardData.goals || dashboardData.goals.length === 0) {
        list.innerHTML = '<p class="empty-state">No goals set. <a href="#" onclick="showAddGoalModal()">Set your first goal</a></p>';
        return;
    }

    list.innerHTML = dashboardData.goals.map(goal => {
        const progress = (goal.saved_amount / goal.target_amount) * 100;
        return `
            <div class="list-item">
                <div class="item-icon goal">
                    <i class="fas fa-bullseye"></i>
                </div>
                <div class="item-content">
                    <div class="item-name">${escapeHtml(goal.name)}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <div class="item-meta">à§³${formatNumber(goal.saved_amount)} / à§³${formatNumber(goal.target_amount)} (${progress.toFixed(1)}%)</div>
                </div>
                <button class="item-delete" onclick="deleteGoal(${goal.id})" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }).join('');
}

// Helper functions
function formatNumber(num) {
    return new Intl.NumberFormat('en-BD').format(Math.round(num));
}

function getSafeNumber(value, fallback = 0) {
    const num = Number(value);
    return Number.isFinite(num) ? num : fallback;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modal functions
function showProfileModal() {
    const modal = createModal('Update Profile', `
        <form id="profileForm" class="form">
            <div class="form-group">
                <label>Monthly Net Income (à§³)</label>
                <input type="number" id="monthlyIncome" value="${dashboardData.user.monthly_net_income}" required>
            </div>
            <div class="form-group">
                <label>Risk Tolerance</label>
                <select id="riskTolerance">
                    <option value="low" ${dashboardData.user.risk_tolerance === 'low' ? 'selected' : ''}>Low</option>
                    <option value="medium" ${dashboardData.user.risk_tolerance === 'medium' ? 'selected' : ''}>Medium</option>
                    <option value="high" ${dashboardData.user.risk_tolerance === 'high' ? 'selected' : ''}>High</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    `);

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await API.post('/profile', {
                monthly_net_income: parseFloat(document.getElementById('monthlyIncome').value),
                risk_tolerance: document.getElementById('riskTolerance').value
            });
            showToast('Profile updated successfully!', 'success');
            closeModal();
            initDashboard();
        } catch (error) {
            showToast(error.message, 'error');
        }
    });
}

function showAddExpenseModal() {
    const modal = createModal('Add Expense', `
        <form id="expenseForm" class="form">
            <div class="form-group">
                <label>Expense Name</label>
                <input type="text" id="expenseName" placeholder="e.g., Rent, Groceries" required>
            </div>
            <div class="form-group">
                <label>Amount (à§³)</label>
                <input type="number" id="expenseAmount" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="expenseType" required>
                    <option value="fixed">Fixed (rent, utilities)</option>
                    <option value="variable">Variable (groceries, entertainment)</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </div>
        </form>
    `);

    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await API.post('/profile/expenses', {
                name: document.getElementById('expenseName').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                type: document.getElementById('expenseType').value
            });
            showToast('Expense added successfully!', 'success');
            closeModal();
            await loadExpenses();
            await loadDashboardSummary();
        } catch (error) {
            showToast(error.message, 'error');
        }
    });
}

function showAddDebtModal() {
    const modal = createModal('Add Debt/Loan', `
        <form id="debtForm" class="form">
            <div class="form-group">
                <label>Loan Name</label>
                <input type="text" id="debtName" placeholder="e.g., Home Loan, Car Loan" required>
            </div>
            <div class="form-group">
                <label>Principal Amount (à§³)</label>
                <input type="number" id="debtPrincipal" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Annual Interest Rate (%)</label>
                <input type="number" id="debtRate" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Term (months)</label>
                <input type="number" id="debtTerm" required>
            </div>
            <div class="form-group">
                <label>Current EMI (à§³)</label>
                <input type="number" id="debtEMI" step="0.01" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Debt</button>
            </div>
        </form>
    `);

    document.getElementById('debtForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await API.post('/profile/debts', {
                name: document.getElementById('debtName').value,
                principal: parseFloat(document.getElementById('debtPrincipal').value),
                annual_rate_pct: parseFloat(document.getElementById('debtRate').value),
                term_months: parseInt(document.getElementById('debtTerm').value),
                current_emi: parseFloat(document.getElementById('debtEMI').value)
            });
            showToast('Debt added successfully!', 'success');
            closeModal();
            await loadDebts();
            await loadDashboardSummary();
        } catch (error) {
            showToast(error.message, 'error');
        }
    });
}

function showAddGoalModal() {
    const modal = createModal('Add Financial Goal', `
        <form id="goalForm" class="form">
            <div class="form-group">
                <label>Goal Name</label>
                <input type="text" id="goalName" placeholder="e.g., Emergency Fund, Vacation" required>
            </div>
            <div class="form-group">
                <label>Target Amount (à§³)</label>
                <input type="number" id="goalTarget" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Already Saved (à§³)</label>
                <input type="number" id="goalSaved" step="0.01" value="0">
            </div>
            <div class="form-group">
                <label>Priority (1-10)</label>
                <input type="number" id="goalPriority" min="1" max="10" value="5">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Goal</button>
            </div>
        </form>
    `);

    document.getElementById('goalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await API.post('/profile/goals', {
                name: document.getElementById('goalName').value,
                target_amount: parseFloat(document.getElementById('goalTarget').value),
                saved_amount: parseFloat(document.getElementById('goalSaved').value),
                priority: parseInt(document.getElementById('goalPriority').value)
            });
            showToast('Goal added successfully!', 'success');
            closeModal();
            await loadGoals();
            await loadDashboardSummary();
        } catch (error) {
            showToast(error.message, 'error');
        }
    });
}

// Delete functions
async function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    try {
        await API.delete(`/profile/expenses/${id}`);
        showToast('Expense deleted', 'success');
        await loadExpenses();
        await loadDashboardSummary();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function deleteDebt(id) {
    if (!confirm('Delete this debt?')) return;
    try {
        await API.delete(`/profile/debts/${id}`);
        showToast('Debt deleted', 'success');
        await loadDebts();
        await loadDashboardSummary();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function deleteGoal(id) {
    if (!confirm('Delete this goal?')) return;
    try {
        await API.delete(`/profile/goals/${id}`);
        showToast('Goal deleted', 'success');
        await loadGoals();
        await loadDashboardSummary();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Tool functions
function showLoanCalculator() {
    const income = dashboardData.user?.monthly_net_income || 0;
    const existingDebt = dashboardData.debts?.reduce((sum, debt) => sum + (debt.current_emi || 0), 0) || 0;

    createModal('Loan Calculator', `
        <form id="loanCalcForm" class="modal-form">
            <div class="form-group">
                <label for="loanIncome">Monthly Net Income (à§³)</label>
                <input type="number" id="loanIncome" min="0" step="0.01" value="${income.toFixed(2)}" required>
            </div>
            <div class="form-group">
                <label for="loanExistingDebt">Existing Monthly Debt (à§³)</label>
                <input type="number" id="loanExistingDebt" min="0" step="0.01" value="${existingDebt.toFixed(2)}" required>
            </div>
            <div class="form-group grid">
                <div>
                    <label for="loanRate">Interest Rate (% p.a.)</label>
                    <input type="number" id="loanRate" min="0" step="0.1" value="12" required>
                </div>
                <div>
                    <label for="loanTerm">Term (months)</label>
                    <input type="number" id="loanTerm" min="6" step="1" value="60" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Calculate</button>
            </div>
            <div id="loanCalcResult" class="tool-result hidden"></div>
        </form>
    `);

    const form = document.getElementById('loanCalcForm');
    const resultBox = document.getElementById('loanCalcResult');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = {
            income: parseFloat(document.getElementById('loanIncome').value),
            existing_monthly_debt: parseFloat(document.getElementById('loanExistingDebt').value),
            annual_rate_pct: parseFloat(document.getElementById('loanRate').value),
            term_months: parseInt(document.getElementById('loanTerm').value)
        };

        if (Object.values(payload).some(v => isNaN(v) || v < 0)) {
            showToast('Please enter valid positive numbers.', 'error');
            return;
        }

        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Calculatingâ€¦';
        resultBox.classList.remove('hidden');
        resultBox.innerHTML = '<div class="loading-inline"><i class="fas fa-spinner fa-spin"></i> Calculating affordabilityâ€¦</div>';

        try {
            const result = await API.post('/calc/loan-pre-assessment', payload);
            const affordableEmi = getSafeNumber(result.affordable_emi);
            const estimatedPrincipal = getSafeNumber(result.estimated_principal);
            const dti = getSafeNumber(result.dti);
            const stressTests = Array.isArray(result.stress_tests) ? result.stress_tests : [];

            const stressRows = stressTests.map(test => {
                const newEmi = formatCurrency(getSafeNumber(test.new_emi));
                const dtiVal = formatPercent(getSafeNumber(test.dti));
                const scenario = escapeHtml(test.scenario || 'Scenario');
                const status = test.is_affordable ? '<span class="badge success">Within limit</span>' : '<span class="badge warning">Above limit</span>';
                return `
                <tr>
                    <td>${scenario}</td>
                    <td>${newEmi}</td>
                    <td>${dtiVal}</td>
                    <td>${status}</td>
                </tr>
                `;
            }).join('');

            resultBox.innerHTML = `
                <div class="result-summary">
                    <div>
                        <p class="label">Affordable EMI</p>
                        <p class="value">${formatCurrency(affordableEmi)}</p>
                    </div>
                    <div>
                        <p class="label">Estimated Principal</p>
                        <p class="value">${formatCurrency(estimatedPrincipal)}</p>
                    </div>
                    <div>
                        <p class="label">Current DTI</p>
                        <p class="value">${formatPercent(dti)}</p>
                    </div>
                </div>
                <div class="result-table-wrapper">
                    <h4>Stress Scenarios</h4>
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>New EMI</th>
                                <th>DTI</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stressRows || '<tr><td colspan="4">No stress tests available.</td></tr>'}
                        </tbody>
                    </table>
                </div>
                ${result.meta?.disclaimer ? `<p class="disclaimer">${escapeHtml(result.meta.disclaimer)}</p>` : ''}
            `;
        } catch (error) {
            resultBox.innerHTML = `<p class="error">${escapeHtml(error.message || 'Calculation failed')}</p>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
}

function showInflationCalculator() {
    const essentialsTotal = dashboardData.expenses?.reduce((sum, item) => sum + (item.amount || 0), 0) || 0;

    createModal('Inflation Forecast', `
        <form id="inflationForm" class="modal-form">
            <div class="form-group">
                <label for="inflationCurrent">Monthly Essential Spend (à§³)</label>
                <input type="number" id="inflationCurrent" min="0" step="0.01" value="${essentialsTotal.toFixed(2)}" required>
                <small>Sum of rent, groceries, utilities, education, etc.</small>
            </div>
            <div class="form-group grid">
                <div>
                    <label for="inflationRate">Expected CPI (% p.a.)</label>
                    <input type="number" id="inflationRate" min="0" step="0.1" value="7" required>
                </div>
                <div>
                    <label for="inflationYears">Projection Horizon (years)</label>
                    <input type="number" id="inflationYears" min="1" max="30" step="1" value="5" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Forecast</button>
            </div>
            <div id="inflationResult" class="tool-result hidden"></div>
        </form>
    `);

    const form = document.getElementById('inflationForm');
    const resultBox = document.getElementById('inflationResult');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = {
            current_price: parseFloat(document.getElementById('inflationCurrent').value),
            annual_cpi_rate: parseFloat(document.getElementById('inflationRate').value),
            years: parseInt(document.getElementById('inflationYears').value)
        };

        if (Object.values(payload).some(v => isNaN(v) || v < 0)) {
            showToast('Please enter valid positive numbers.', 'error');
            return;
        }

        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Projectingâ€¦';
        resultBox.classList.remove('hidden');
        resultBox.innerHTML = '<div class="loading-inline"><i class="fas fa-spinner fa-spin"></i> Calculating projectionâ€¦</div>';

        try {
            const result = await API.post('/calc/inflation-forecast', payload);
            const projections = Array.isArray(result.projections) ? result.projections : [];
            const rows = projections.map(item => `
                <tr>
                    <td>Year ${escapeHtml(String(item.year))}</td>
                    <td>${formatCurrency(getSafeNumber(item.estimated_price))}</td>
                </tr>
            `).join('');

            resultBox.innerHTML = `
                <div class="result-table-wrapper">
                    <h4>Projected Monthly Cost</h4>
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Estimated Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows || '<tr><td colspan="2">No projections generated.</td></tr>'}
                        </tbody>
                    </table>
                </div>
                ${result.meta?.disclaimer ? `<p class="disclaimer">${escapeHtml(result.meta.disclaimer)}</p>` : ''}
            `;
        } catch (error) {
            resultBox.innerHTML = `<p class="error">${escapeHtml(error.message || 'Forecast failed')}</p>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
}

function showAIAdvisor() {
    createModal('AI Financial Advisor', `
        <form id="aiForm" class="modal-form">
            <div class="form-group">
                <label for="aiQuestion">Ask a question</label>
                <textarea id="aiQuestion" rows="5" placeholder="e.g., How can I optimize my monthly budget?" required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Get Guidance</button>
            </div>
            <div id="aiResult" class="tool-result hidden"></div>
        </form>
    `);

    const form = document.getElementById('aiForm');
    const resultBox = document.getElementById('aiResult');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const question = document.getElementById('aiQuestion').value.trim();
        if (!question) {
            showToast('Please enter a question.', 'error');
            return;
        }

        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Thinkingâ€¦';
        resultBox.classList.remove('hidden');
        resultBox.innerHTML = '<div class="loading-inline"><i class="fas fa-spinner fa-spin"></i> Generating guidanceâ€¦</div>';

        try {
            const result = await API.post('/ai/ask', { question });
            const answerHtml = escapeHtml(result.answer).replace(/\n/g, '<br>');
            resultBox.innerHTML = `
                <div class="ai-response ${result.is_blocked ? 'blocked' : ''}">
                    <p>${answerHtml}</p>
                    ${result.is_blocked ? '<p class="warning">This topic requires a licensed financial services partner.</p>' : ''}
                </div>
                ${result.meta?.disclaimer ? `<p class="disclaimer">${escapeHtml(result.meta.disclaimer)}</p>` : ''}
            `;
        } catch (error) {
            resultBox.innerHTML = `<p class="error">${escapeHtml(error.message || 'AI advisor unavailable')}</p>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
}

function showDataImport() {
    createModal('Import Transactions (CSV)', `
        <form id="importForm" class="modal-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="importFile">Upload CSV</label>
                <input type="file" id="importFile" accept=".csv" required>
                <small>Expected columns: date, description, category (optional), amount</small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Import</button>
            </div>
            <div id="importResult" class="tool-result hidden"></div>
        </form>
    `);

    const form = document.getElementById('importForm');
    const fileInput = document.getElementById('importFile');
    const resultBox = document.getElementById('importResult');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!fileInput.files || !fileInput.files.length) {
            showToast('Please select a CSV file to upload.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('has_header', 'true');

        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Importingâ€¦';
        resultBox.classList.remove('hidden');
        resultBox.innerHTML = '<div class="loading-inline"><i class="fas fa-spinner fa-spin"></i> Processing fileâ€¦</div>';

        try {
            const result = await API.post('/data/import-csv', formData);
            resultBox.innerHTML = `
                <div class="success">
                    <p>${escapeHtml(result.message)}</p>
                    <ul>
                        <li><strong>Rows processed:</strong> ${getSafeNumber(result.rows_processed)}</li>
                        <li><strong>Expenses added:</strong> ${getSafeNumber(result.expenses_added)}</li>
                    </ul>
                </div>
            `;

            await Promise.all([
                loadExpenses(),
                loadDashboardSummary()
            ]);
        } catch (error) {
            resultBox.innerHTML = `<p class="error">${escapeHtml(error.message || 'Import failed')}</p>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
}

// Modal helper functions
function createModal(title, content) {
    const modalHTML = `
        <div class="modal-overlay" onclick="closeModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h2>${title}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modalHTML;
}

function closeModal() {
    document.getElementById('modalContainer').innerHTML = '';
}
</script>
{% endblock %}